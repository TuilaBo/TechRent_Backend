<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/lib/stomp.min.js"></script>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    
    <div>
        <label>Conversation ID: </label>
        <input type="number" id="conversationId" value="1">
        <br><br>
        
        <label>Sender Type: </label>
        <select id="senderType">
            <option value="CUSTOMER">CUSTOMER</option>
            <option value="STAFF">STAFF</option>
        </select>
        <br><br>
        
        <label>Sender ID: </label>
        <input type="number" id="senderId" value="1">
        <br><br>
        
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <hr>
    
    <div>
        <input type="text" id="messageInput" placeholder="Nhập tin nhắn...">
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <hr>
    
    <div id="messages" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">
        <p>Messages sẽ hiển thị ở đây...</p>
    </div>

    <script>
        let stompClient = null;
        let conversationId = null;

        function connect() {
            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            
            conversationId = document.getElementById('conversationId').value;
            
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                addMessage('System', 'Đã kết nối thành công!', 'green');
                
                // Subscribe vào conversation
                stompClient.subscribe('/topic/conversation/' + conversationId, function (message) {
                    const chatMessage = JSON.parse(message.body);
                    const sender = chatMessage.senderType === 'CUSTOMER' ? 'Customer ' + chatMessage.senderId : 'Staff ' + chatMessage.senderId;
                    addMessage(sender, chatMessage.content, 'blue');
                });
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                addMessage('System', 'Đã ngắt kết nối', 'red');
            }
        }

        function sendMessage() {
            if (stompClient === null) {
                alert('Chưa kết nối! Click Connect trước.');
                return;
            }
            
            const conversationId = document.getElementById('conversationId').value;
            const senderType = document.getElementById('senderType').value;
            const senderId = parseInt(document.getElementById('senderId').value);
            const content = document.getElementById('messageInput').value;
            
            if (!content.trim()) {
                alert('Nhập tin nhắn!');
                return;
            }
            
            const message = {
                conversationId: parseInt(conversationId),
                senderType: senderType,
                senderId: senderId,
                content: content
            };
            
            // Gửi đến server
            stompClient.send("/app/chat.send", {}, JSON.stringify(message));
            
            // Clear input
            document.getElementById('messageInput').value = '';
        }

        function addMessage(sender, content, color) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('p');
            messageElement.style.color = color;
            messageElement.innerHTML = '<strong>' + sender + ':</strong> ' + content + ' <small>(' + new Date().toLocaleTimeString() + ')</small>';
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>

